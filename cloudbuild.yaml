# cloudbuild.yaml

steps:
# 1. Build Backend Docker Image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/${PROJECT_ID}/playlist-tracker-backend:latest', './backend']
  dir: '.' # Execute from the project root

# 2. Deploy Backend to Cloud Run
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  args:
  - gcloud
  - run
  - deploy
  - playlist-tracker-backend # Name of your backend Cloud Run service
  - --image=gcr.io/${PROJECT_ID}/playlist-tracker-backend:latest
  - --region=europe-west2
  - --platform=managed
  - --allow-unauthenticated
  - --port=5000
  - --set-env-vars=DB_URI=${_DB_URI},JWT_SECRET=${_JWT_SECRET},YOUTUBE_API_KEY=${_YOUTUBE_API_KEY}
  - --timeout=900
  - --cpu=1
  - --memory=512Mi
  - --max-instances=2
  - --min-instances=0
  - --project=${PROJECT_ID}
  id: Deploy Backend Service

# 3. Get the URL of the deployed Backend Service
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  args:
  - gcloud
  - run
  - services
  - describe
  - playlist-tracker-backend
  - --platform=managed
  - --region=europe-west2
  - --format=value(status.url)
  - --project=${PROJECT_ID}
  id: Get Backend URL
  entrypoint: /bin/bash
  script: |
    gcloud run services describe playlist-tracker-backend \
      --platform=managed \
      --region=europe-west2 \
      --format='value(status.url)' \
      --project=${PROJECT_ID} > /workspace/backend_url.txt


# 4. Build Frontend Docker Image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/${PROJECT_ID}/playlist-tracker-frontend:latest', './frontend']
  dir: '.'

# 5. Deploy Frontend to Cloud Run
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  args:
  - gcloud
  - run
  - deploy
  - playlist-tracker-frontend # Name of your frontend Cloud Run service
  - --image=gcr.io/${PROJECT_ID}/playlist-tracker-frontend:latest
  - --region=europe-west2
  - --platform=managed
  - --allow-unauthenticated
  - --port=80 # Nginx in frontend Dockerfile exposes port 80
  - --set-env-vars=REACT_APP_API_URL=$(cat /workspace/backend_url.txt)
  - --timeout=300
  - --cpu=1
  - --memory=256Mi
  - --max-instances=1
  - --min-instances=0
  - --project=${PROJECT_ID}
  id: Deploy Frontend Service

substitutions:
  _DB_URI: "mongodb+srv://Verserain:WMkIlGNehps3HVR8@playlisttrackercluster.mgmfxzc.mongodb.net/?retryWrites=true&w=majority&appName=PlaylistTrackerCluster"
  _JWT_SECRET: "e28ebe55a47120930a70e642fa46e1dd7f0dd0f07fb8d12ba1712c3496e8daf8"
  _YOUTUBE_API_KEY: "AIzaSyAeKYJpY0IJBQxFfAff-b5lZzVxaZd0TwI"